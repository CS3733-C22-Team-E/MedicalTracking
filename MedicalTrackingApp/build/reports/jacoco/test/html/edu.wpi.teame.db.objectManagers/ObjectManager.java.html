<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ObjectManager.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">MedicalTrackingApp</a> &gt; <a href="index.source.html" class="el_package">edu.wpi.teame.db.objectManagers</a> &gt; <span class="el_source">ObjectManager.java</span></div><h1>ObjectManager.java</h1><pre class="source lang-java linenums">package edu.wpi.teame.db.objectManagers;

import com.opencsv.CSVReader;
import com.opencsv.CSVWriter;
import com.opencsv.exceptions.CsvValidationException;
import edu.wpi.teame.App;
import edu.wpi.teame.db.CSVLineData;
import edu.wpi.teame.db.CSVManager;
import edu.wpi.teame.db.DBManager;
import edu.wpi.teame.db.ISQLSerializable;
import edu.wpi.teame.model.*;
import edu.wpi.teame.model.enums.DataBaseObjectType;
import edu.wpi.teame.model.serviceRequests.*;
import java.io.FileWriter;
import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.sql.*;
import java.text.ParseException;
import java.util.ArrayList;
import java.util.Date;
import java.util.LinkedList;
import java.util.List;

public abstract class ObjectManager&lt;T extends ISQLSerializable&gt; implements IManager&lt;T&gt; {
  protected DataBaseObjectType objectType;
<span class="nc" id="L27">  private Date lastLoaded = new Date(0);</span>
  private List&lt;T&gt; loadedObjects;
  private long refreshInterval;

<span class="nc" id="L31">  public ObjectManager(DataBaseObjectType objectType, long refreshInterval) {</span>
<span class="nc" id="L32">    this.refreshInterval = refreshInterval;</span>
<span class="nc" id="L33">    loadedObjects = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L34">    this.objectType = objectType;</span>
<span class="nc" id="L35">  }</span>

  @Override
  public List&lt;T&gt; getAll() throws SQLException {
<span class="nc bnc" id="L39" title="All 2 branches missed.">    if (shouldReload()) {</span>
<span class="nc" id="L40">      loadedObjects = getBy(&quot; WHERE isDeleted = 0&quot;);</span>
    }
<span class="nc" id="L42">    return loadedObjects;</span>
  }

  @Override
  public List&lt;T&gt; forceGetAll() throws SQLException {
<span class="nc" id="L47">    lastLoaded = new Date(0);</span>
<span class="nc" id="L48">    return getAll();</span>
  }

  @Override
  public List&lt;T&gt; getDeleted() throws SQLException {
<span class="nc" id="L53">    return getBy(&quot; WHERE isDeleted = 1&quot;);</span>
  }

  @Override
  public T get(int id) throws SQLException {
<span class="nc" id="L58">    getAll();</span>
<span class="nc bnc" id="L59" title="All 2 branches missed.">    for (T object : loadedObjects) {</span>
<span class="nc bnc" id="L60" title="All 2 branches missed.">      if (object.getId() == id) {</span>
<span class="nc" id="L61">        return object;</span>
      }
<span class="nc" id="L63">    }</span>
<span class="nc" id="L64">    return null;</span>
  }

  protected List&lt;T&gt; getBy(String whereClause) throws SQLException {
<span class="nc" id="L68">    String getQuery = &quot;SELECT * FROM &quot; + objectType.toTableName() + &quot; &quot; + whereClause;</span>
    ResultSet resultSet =
<span class="nc" id="L70">        DBManager.getInstance().getConnection().createStatement().executeQuery(getQuery);</span>
<span class="nc" id="L71">    List&lt;T&gt; listResult = new LinkedList&lt;&gt;();</span>
<span class="nc bnc" id="L72" title="All 2 branches missed.">    while (resultSet.next()) {</span>
<span class="nc" id="L73">      listResult.add(getCastedType(resultSet));</span>
    }
<span class="nc" id="L75">    return listResult;</span>
  }

  @Override
  public T insert(T newObject) throws SQLException {
<span class="nc" id="L80">    StringBuilder insertQuery = new StringBuilder(&quot;INSERT INTO &quot;);</span>
<span class="nc" id="L81">    insertQuery.append(objectType.toTableName()).append(newObject.getTableColumns());</span>
<span class="nc" id="L82">    insertQuery.append(&quot; VALUES(&quot;);</span>
<span class="nc" id="L83">    insertQuery.append(newObject.getSQLInsertString()).append(&quot;)&quot;);</span>
<span class="nc" id="L84">    System.out.println(insertQuery);</span>
    PreparedStatement insertStatement =
<span class="nc" id="L86">        DBManager.getInstance()</span>
<span class="nc" id="L87">            .getConnection()</span>
<span class="nc" id="L88">            .prepareStatement(insertQuery.toString(), Statement.RETURN_GENERATED_KEYS);</span>
<span class="nc" id="L89">    int rowsAffected = insertStatement.executeUpdate();</span>
<span class="nc" id="L90">    ResultSet resultSet = insertStatement.getGeneratedKeys();</span>

<span class="nc" id="L92">    resultSet.next();</span>
<span class="nc" id="L93">    long id = resultSet.getLong(1);</span>
<span class="nc" id="L94">    lastLoaded = new Date(0); // Ensure the table is loaded next time we get</span>
<span class="nc" id="L95">    return get((int) id);</span>
  }

  @Override
  public void update(T updatedObject) throws SQLException {
<span class="nc" id="L100">    StringBuilder updateQuery = new StringBuilder(&quot;UPDATE &quot;);</span>
<span class="nc" id="L101">    updateQuery.append(objectType.toTableName()).append(&quot; SET &quot;);</span>
<span class="nc" id="L102">    updateQuery.append(updatedObject.getSQLUpdateString());</span>
<span class="nc" id="L103">    DBManager.getInstance().getConnection().createStatement().executeUpdate(updateQuery.toString());</span>
<span class="nc" id="L104">    lastLoaded = new Date(0); // Ensure the table is loaded next time we get</span>
<span class="nc" id="L105">  }</span>

  @Override
  public void remove(int id) throws SQLException {
<span class="nc" id="L109">    StringBuilder markIsDeleted = new StringBuilder(&quot;UPDATE &quot;);</span>
<span class="nc" id="L110">    markIsDeleted</span>
<span class="nc" id="L111">        .append(objectType.toTableName())</span>
<span class="nc" id="L112">        .append(&quot; SET isDeleted = 1&quot;)</span>
<span class="nc" id="L113">        .append(&quot; WHERE id = &quot;)</span>
<span class="nc" id="L114">        .append(id);</span>
<span class="nc" id="L115">    DBManager.getInstance()</span>
<span class="nc" id="L116">        .getConnection()</span>
<span class="nc" id="L117">        .createStatement()</span>
<span class="nc" id="L118">        .executeUpdate(markIsDeleted.toString());</span>
<span class="nc" id="L119">    lastLoaded = new Date(0); // Ensure the table is loaded next time we get</span>
<span class="nc" id="L120">  }</span>

  @Override
  public void restore(int id) throws SQLException {
<span class="nc" id="L124">    StringBuilder restoreQuery = new StringBuilder(&quot;UPDATE &quot;);</span>
<span class="nc" id="L125">    restoreQuery</span>
<span class="nc" id="L126">        .append(objectType.toTableName())</span>
<span class="nc" id="L127">        .append(&quot; SET isDeleted = 0&quot;)</span>
<span class="nc" id="L128">        .append(&quot; WHERE id = &quot;)</span>
<span class="nc" id="L129">        .append(id);</span>
<span class="nc" id="L130">    DBManager.getInstance()</span>
<span class="nc" id="L131">        .getConnection()</span>
<span class="nc" id="L132">        .createStatement()</span>
<span class="nc" id="L133">        .executeUpdate(restoreQuery.toString());</span>
<span class="nc" id="L134">    lastLoaded = new Date(0); // Ensure the table is loaded next time we get</span>
<span class="nc" id="L135">  }</span>

  @Override
  public void readCSV(String inputFileName)
      throws IOException, SQLException, CsvValidationException, ParseException {
<span class="nc" id="L140">    InputStream filePath =</span>
<span class="nc" id="L141">        App.class.getClassLoader().getResourceAsStream(&quot;edu/wpi/teame/csv/&quot; + inputFileName);</span>
<span class="nc" id="L142">    CSVReader csvReader = new CSVReader(new InputStreamReader(filePath));</span>
<span class="nc" id="L143">    CSVLineData lineData = new CSVLineData(csvReader);</span>

    // Check if we found anything in the CSV file
<span class="nc bnc" id="L146" title="All 2 branches missed.">    if (!lineData.readHeaders()) {</span>
<span class="nc" id="L147">      return;</span>
    }

<span class="nc bnc" id="L150" title="All 2 branches missed.">    while (lineData.readNext()) {</span>
<span class="nc" id="L151">      T object = insert(getCastedType(lineData));</span>
<span class="nc" id="L152">      CSVManager.getInstance()</span>
<span class="nc" id="L153">          .putCsvToDBId(objectType, lineData.getColumnInt(&quot;id&quot;), object.getId());</span>
<span class="nc" id="L154">    }</span>
<span class="nc" id="L155">  }</span>

  @Override
  public void writeToCSV(String outputFileName) throws IOException, SQLException {
<span class="nc" id="L159">    String filePath =</span>
<span class="nc" id="L160">        App.class.getClassLoader().getResource(&quot;edu/wpi/teame/csv/&quot; + outputFileName).getFile();</span>
<span class="nc" id="L161">    FileWriter outputFile = new FileWriter(filePath);</span>
<span class="nc" id="L162">    CSVWriter writer =</span>
        new CSVWriter(
            outputFile,
            ',',
            CSVWriter.NO_QUOTE_CHARACTER,
            CSVWriter.DEFAULT_ESCAPE_CHARACTER,
            CSVWriter.DEFAULT_LINE_END);

<span class="nc" id="L170">    List&lt;T&gt; dbObjectList = getAll();</span>
<span class="nc" id="L171">    List&lt;String[]&gt; data = new ArrayList&lt;String[]&gt;();</span>

<span class="nc bnc" id="L173" title="All 2 branches missed.">    if (dbObjectList.isEmpty()) {</span>
<span class="nc" id="L174">      return;</span>
    }

<span class="nc" id="L177">    data.add(dbObjectList.get(0).getCSVHeaders());</span>
<span class="nc bnc" id="L178" title="All 2 branches missed.">    for (T dbObject : dbObjectList) {</span>
<span class="nc" id="L179">      data.add(dbObject.toCSVData());</span>
<span class="nc" id="L180">    }</span>
<span class="nc" id="L181">    writer.writeAll(data);</span>
<span class="nc" id="L182">    writer.close();</span>
<span class="nc" id="L183">  }</span>

  private T getCastedType(CSVLineData lineData) throws SQLException, ParseException {
<span class="nc bnc" id="L186" title="All 15 branches missed.">    switch (objectType) {</span>
      case AudioVisualSR:
      case ComputerSR:
      case DeceasedBodySR:
      case FacilitiesMaintenanceSR:
      case LaundrySR:
      case SanitationSR:
      case SecuritySR:
      case MentalHealthSR:
      case PatientDischargeSR:
<span class="nc" id="L196">        return (T) new ServiceRequest(lineData, objectType);</span>
      case ExternalPatientSR:
<span class="nc" id="L198">        return (T) new PatientTransportationServiceRequest(lineData, false);</span>
      case FoodDeliverySR:
<span class="nc" id="L200">        return (T) new FoodDeliveryServiceRequest(lineData);</span>
      case GiftAndFloralSR:
<span class="nc" id="L202">        return (T) new GiftAndFloralServiceRequest(lineData);</span>
      case InternalPatientTransferSR:
<span class="nc" id="L204">        return (T) new PatientTransportationServiceRequest(lineData, true);</span>
      case LanguageInterpreterSR:
<span class="nc" id="L206">        return (T) new LanguageInterpreterServiceRequest(lineData);</span>
      case MedicalEquipmentSR:
<span class="nc" id="L208">        return (T) new MedicalEquipmentServiceRequest(lineData);</span>
      case MedicineDeliverySR:
<span class="nc" id="L210">        return (T) new MedicineDeliveryServiceRequest(lineData);</span>
      case ReligiousSR:
<span class="nc" id="L212">        return (T) new ReligiousServiceRequest(lineData);</span>
      case Location:
<span class="nc" id="L214">        return (T) new Location(lineData);</span>
      case Equipment:
<span class="nc" id="L216">        return (T) new Equipment(lineData);</span>
      case Employee:
<span class="nc" id="L218">        return (T) new Employee(lineData);</span>
      case Patient:
<span class="nc" id="L220">        return (T) new Patient(lineData);</span>
      case Edge:
<span class="nc" id="L222">        return (T) new Edge(lineData);</span>
    }
<span class="nc" id="L224">    return null;</span>
  }

  private T getCastedType(ResultSet resultSet) throws SQLException {
<span class="nc bnc" id="L228" title="All 15 branches missed.">    switch (objectType) {</span>
      case AudioVisualSR:
      case ComputerSR:
      case DeceasedBodySR:
      case FacilitiesMaintenanceSR:
      case LaundrySR:
      case SanitationSR:
      case SecuritySR:
      case MentalHealthSR:
      case PatientDischargeSR:
<span class="nc" id="L238">        return (T) new ServiceRequest(resultSet, objectType);</span>
      case ExternalPatientSR:
<span class="nc" id="L240">        return (T) new PatientTransportationServiceRequest(resultSet, false);</span>
      case FoodDeliverySR:
<span class="nc" id="L242">        return (T) new FoodDeliveryServiceRequest(resultSet);</span>
      case GiftAndFloralSR:
<span class="nc" id="L244">        return (T) new GiftAndFloralServiceRequest(resultSet);</span>
      case InternalPatientTransferSR:
<span class="nc" id="L246">        return (T) new PatientTransportationServiceRequest(resultSet, true);</span>
      case LanguageInterpreterSR:
<span class="nc" id="L248">        return (T) new LanguageInterpreterServiceRequest(resultSet);</span>
      case MedicalEquipmentSR:
<span class="nc" id="L250">        return (T) new MedicalEquipmentServiceRequest(resultSet);</span>
      case MedicineDeliverySR:
<span class="nc" id="L252">        return (T) new MedicineDeliveryServiceRequest(resultSet);</span>
      case ReligiousSR:
<span class="nc" id="L254">        return (T) new ReligiousServiceRequest(resultSet);</span>
      case Location:
<span class="nc" id="L256">        return (T) new Location(resultSet);</span>
      case Equipment:
<span class="nc" id="L258">        return (T) new Equipment(resultSet);</span>
      case Employee:
<span class="nc" id="L260">        return (T) new Employee(resultSet);</span>
      case Patient:
<span class="nc" id="L262">        return (T) new Patient(resultSet);</span>
      case Edge:
<span class="nc" id="L264">        return (T) new Edge(resultSet);</span>
    }
<span class="nc" id="L266">    return null;</span>
  }

  private boolean shouldReload() {
<span class="nc" id="L270">    long millisPassed = new Date().getTime() - lastLoaded.getTime();</span>
<span class="nc" id="L271">    long minutesPassed = (millisPassed / 1000) / 60;</span>
<span class="nc bnc" id="L272" title="All 2 branches missed.">    boolean shouldReload = minutesPassed &gt; refreshInterval;</span>

<span class="nc bnc" id="L274" title="All 2 branches missed.">    if (shouldReload) {</span>
<span class="nc" id="L275">      lastLoaded = new Date();</span>
    }
<span class="nc" id="L277">    return shouldReload;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.4.201905082037</span></div></body></html>