<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Map.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">MedicalTrackingApp</a> &gt; <a href="index.source.html" class="el_package">edu.wpi.teame.view.map</a> &gt; <span class="el_source">Map.java</span></div><h1>Map.java</h1><pre class="source lang-java linenums">package edu.wpi.teame.view.map;

import com.jfoenix.controls.JFXButton;
import com.jfoenix.controls.JFXCheckBox;
import com.jfoenix.controls.JFXComboBox;
import edu.wpi.teame.App;
import edu.wpi.teame.db.DBManager;
import edu.wpi.teame.db.objectManagers.EmployeeManager;
import edu.wpi.teame.db.objectManagers.LocationManager;
import edu.wpi.teame.model.Employee;
import edu.wpi.teame.model.Equipment;
import edu.wpi.teame.model.Location;
import edu.wpi.teame.model.enums.*;
import edu.wpi.teame.model.serviceRequests.MedicalEquipmentServiceRequest;
import edu.wpi.teame.model.serviceRequests.ServiceRequest;
import edu.wpi.teame.view.controllers.AutoCompleteTextField;
import edu.wpi.teame.view.controllers.LandingPageController;
import edu.wpi.teame.view.controllers.ServiceRequestDirectoryPageController;
import edu.wpi.teame.view.controllers.serviceRequests.MedicalEquipmentDeliveryServiceRequestPageServiceRequestController;
import edu.wpi.teame.view.map.Astar.MapIntegration.PathFinder;
import edu.wpi.teame.view.map.Icons.MapEquipmentIcon;
import edu.wpi.teame.view.map.Icons.MapLocationDot;
import edu.wpi.teame.view.map.Icons.MapServiceRequestIcon;
import java.sql.SQLException;
import java.time.LocalDate;
import java.util.*;
import javafx.application.Platform;
import javafx.event.ActionEvent;
import javafx.event.EventHandler;
import javafx.geometry.Insets;
import javafx.geometry.Point2D;
import javafx.scene.Cursor;
import javafx.scene.Node;
import javafx.scene.Parent;
import javafx.scene.control.*;
import javafx.scene.image.Image;
import javafx.scene.image.ImageView;
import javafx.scene.input.MouseButton;
import javafx.scene.input.MouseEvent;
import javafx.scene.input.ScrollEvent;
import javafx.scene.layout.GridPane;
import javafx.scene.layout.Pane;
import javafx.scene.layout.StackPane;
import javafx.scene.paint.Color;
import javafx.stage.Screen;
import javafx.util.Pair;

public class Map {
<span class="nc" id="L49">  private final HashMap&lt;FloorType, Image&gt; Images = new HashMap&lt;&gt;();</span>
<span class="nc" id="L50">  private final int WIDTH = 0;</span>
<span class="nc" id="L51">  private final int HEIGHT = 0;</span>
<span class="nc" id="L52">  private final double ZOOMINMAX = 1.5;</span>
<span class="nc" id="L53">  private final double ZOOMOUTMAX = .2;</span>
<span class="nc" id="L54">  private final HashMap&lt;FloorType, ArrayList&lt;MapEquipmentIcon&gt;&gt; mapIconsByFloor = new HashMap&lt;&gt;();</span>
<span class="nc" id="L55">  private final HashMap&lt;FloorType, ArrayList&lt;MapLocationDot&gt;&gt; locationsByFloor = new HashMap&lt;&gt;();</span>
<span class="nc" id="L56">  private final HashMap&lt;FloorType, ArrayList&lt;RadialEquipmentMenu&gt;&gt; radialMenusByFloor =</span>
      new HashMap&lt;&gt;();
<span class="nc" id="L58">  private final HashMap&lt;EquipmentType, Image&gt; TypeGraphics = new HashMap&lt;EquipmentType, Image&gt;();</span>
<span class="nc" id="L59">  private final HashMap&lt;FloorType, ArrayList&lt;MapServiceRequestIcon&gt;&gt; ActiveSRByFloor =</span>
      new HashMap&lt;&gt;();
<span class="nc" id="L61">  private final ContextMenu EquipmentClicked = new ContextMenu();</span>
<span class="nc" id="L62">  private final ContextMenu PaneMenu = new ContextMenu();</span>
<span class="nc" id="L63">  private final StackPane layout = new StackPane();</span>
  private final LandingPageController appController;
  private Image backgroundImage;
<span class="nc" id="L66">  private double MAPHEIGHT = 0;</span>
<span class="nc" id="L67">  private double MAPWIDTH = 0;</span>
<span class="nc" id="L68">  private boolean showLocationNodes = false;</span>
  private JFXButton lastPressed;
<span class="nc" id="L70">  private Point2D lastPressedPoint = new Point2D(0, 0);</span>
  private Location lastPressedLocation;
  private Location location;
  private FloorType currFloor;
<span class="nc" id="L74">  private ArrayList&lt;ServiceRequest&gt; oldSR = new ArrayList&lt;ServiceRequest&gt;();</span>
<span class="nc" id="L75">  private PathFinder Navigation = null;</span>
<span class="nc" id="L76">  private ArrayList&lt;MapLocationDot&gt; PathFindingLocations = new ArrayList&lt;&gt;();</span>

<span class="nc" id="L78">  public Map(FloorType floor, LandingPageController app) throws SQLException {</span>
<span class="nc" id="L79">    appController = app;</span>
<span class="nc" id="L80">    currFloor = floor;</span>
<span class="nc bnc" id="L81" title="All 2 branches missed.">    for (FloorType currFloor : FloorType.values()) {</span>
<span class="nc" id="L82">      Images.put(currFloor, new Image(getImageResource(getMapImg(currFloor))));</span>
<span class="nc" id="L83">      mapIconsByFloor.put(currFloor, new ArrayList&lt;&gt;());</span>
<span class="nc" id="L84">      locationsByFloor.put(currFloor, new ArrayList&lt;&gt;());</span>
<span class="nc" id="L85">      radialMenusByFloor.put(currFloor, new ArrayList&lt;&gt;());</span>
<span class="nc" id="L86">      ActiveSRByFloor.put(currFloor, new ArrayList&lt;&gt;());</span>
    }
<span class="nc" id="L88">    System.out.println(&quot;Loaded Maps&quot;);</span>
<span class="nc" id="L89">    switchFloors(floor);</span>
<span class="nc" id="L90">  }</span>

  private String getMapImg(FloorType f) {
<span class="nc bnc" id="L93" title="All 7 branches missed.">    switch (f) {</span>
      case GroundFloor:
<span class="nc" id="L95">        return &quot;images/map/00_thegroundfloorNew.png&quot;;</span>
      case LowerLevel1:
<span class="nc" id="L97">        return &quot;images/map/00_thelowerlevel1New.png&quot;;</span>
      case LowerLevel2:
<span class="nc" id="L99">        return &quot;images/map/00_thelowerlevel2New.png&quot;;</span>
      case FirstFloor:
<span class="nc" id="L101">        return &quot;images/map/01_thefirstfloorNew.png&quot;;</span>
      case SecondFloor:
<span class="nc" id="L103">        return &quot;images/map/02_thesecondfloorNew.png&quot;;</span>
      case ThirdFloor:
<span class="nc" id="L105">        return &quot;images/map/03_thethirdfloorNew.png&quot;;</span>
      default:
<span class="nc" id="L107">        return &quot;&quot;;</span>
    }
  }

  public void switchFloors(FloorType floor) throws SQLException {
<span class="nc" id="L112">    currFloor = floor;</span>
<span class="nc" id="L113">    backgroundImage = Images.get(floor);</span>
<span class="nc" id="L114">    MAPHEIGHT = backgroundImage.getHeight();</span>
<span class="nc" id="L115">    MAPWIDTH = backgroundImage.getWidth();</span>
<span class="nc" id="L116">    updateLayoutChildren();</span>
<span class="nc bnc" id="L117" title="All 2 branches missed.">    if (Navigation != null) {</span>
<span class="nc" id="L118">      Navigation.RemoveRoute();</span>
<span class="nc" id="L119">      Navigation.SelectFloor(MAPWIDTH, MAPHEIGHT);</span>
<span class="nc" id="L120">      System.out.println(MAPWIDTH + &quot; &quot; + MAPHEIGHT);</span>
    }
<span class="nc" id="L122">  }</span>

  private boolean coordinateChecker(String X, String Y) {
<span class="nc" id="L125">    double doubleX = Double.parseDouble(X);</span>
<span class="nc" id="L126">    double doubleY = Double.parseDouble(Y);</span>
<span class="nc bnc" id="L127" title="All 8 branches missed.">    return doubleX &gt; 0 &amp;&amp; doubleX &lt; MAPWIDTH &amp;&amp; doubleY &gt; 0 &amp;&amp; doubleY &lt; MAPHEIGHT;</span>
  }

  public void deleteMapIcon(JFXButton button) {
<span class="nc" id="L131">    mapIconsByFloor.get(currFloor).removeIf(mapIcon -&gt; mapIcon.Button.equals(button));</span>
<span class="nc" id="L132">  }</span>

  public MenuItem createEquipmentMenuItem(EquipmentType equiptype) {
<span class="nc" id="L135">    MenuItem retval = new MenuItem(equiptype.toString());</span>
<span class="nc" id="L136">    retval.setOnAction(</span>
<span class="nc" id="L137">        new EventHandler&lt;ActionEvent&gt;() {</span>
          @Override
          public void handle(ActionEvent event) {
<span class="nc" id="L140">            Equipment ToBeInserted =</span>
<span class="nc" id="L141">                new Equipment(0, lastPressedLocation, equiptype, equiptype.toString(), false, true);</span>
            try {
<span class="nc" id="L143">              DBManager.getInstance().getManager(DataBaseObjectType.Equipment).insert(ToBeInserted);</span>
<span class="nc" id="L144">              addEquipmentToMap(ToBeInserted);</span>
<span class="nc" id="L145">            } catch (SQLException e) {</span>
<span class="nc" id="L146">              e.printStackTrace();</span>
<span class="nc" id="L147">            }</span>
<span class="nc" id="L148">          }</span>
        });
<span class="nc" id="L150">    return retval;</span>
  }

  public void showEditLastPressedDialog() {
<span class="nc" id="L154">    Dialog&lt;Pair&lt;Double, Double&gt;&gt; dialog = new Dialog&lt;&gt;();</span>
<span class="nc" id="L155">    dialog.setTitle(&quot;Move Equipment&quot;);</span>
<span class="nc" id="L156">    dialog.setHeaderText(&quot;Choose the X and Y Position&quot;);</span>
    // Set the button types.
<span class="nc" id="L158">    ButtonType Move = new ButtonType(&quot;Move&quot;, ButtonBar.ButtonData.OK_DONE);</span>
<span class="nc" id="L159">    dialog.getDialogPane().getButtonTypes().addAll(Move, ButtonType.CANCEL);</span>

    // Create the username and password labels and fields.
<span class="nc" id="L162">    GridPane grid = new GridPane();</span>
<span class="nc" id="L163">    grid.setHgap(10);</span>
<span class="nc" id="L164">    grid.setVgap(10);</span>
<span class="nc" id="L165">    grid.setPadding(new Insets(20, 150, 10, 10));</span>

<span class="nc" id="L167">    TextField XPosition = new TextField();</span>
<span class="nc" id="L168">    XPosition.setPromptText(&quot;X Position&quot;);</span>
<span class="nc" id="L169">    TextField YPosition = new TextField();</span>
<span class="nc" id="L170">    YPosition.setPromptText(&quot;Y Position&quot;);</span>

<span class="nc" id="L172">    grid.add(new Label(&quot;X Position:&quot;), 0, 0);</span>
<span class="nc" id="L173">    grid.add(XPosition, 1, 0);</span>
<span class="nc" id="L174">    grid.add(new Label(&quot;Y Position:&quot;), 0, 1);</span>
<span class="nc" id="L175">    grid.add(YPosition, 1, 1);</span>

    // Enable/Disable login button depending on whether a username was entered.
<span class="nc" id="L178">    Node MoveButton = dialog.getDialogPane().lookupButton(Move);</span>
<span class="nc" id="L179">    MoveButton.setDisable(true);</span>

    // Do some validation (using the Java 8 lambda syntax).
<span class="nc" id="L182">    XPosition.textProperty()</span>
<span class="nc" id="L183">        .addListener(</span>
            (observable, oldValue, newValue) -&gt; {
<span class="nc" id="L185">              MoveButton.setDisable(</span>
<span class="nc bnc" id="L186" title="All 2 branches missed.">                  newValue.trim().isEmpty()</span>
<span class="nc bnc" id="L187" title="All 2 branches missed.">                      || YPosition.getText().isBlank()</span>
<span class="nc bnc" id="L188" title="All 2 branches missed.">                      || !coordinateChecker(XPosition.getText(), YPosition.getText()));</span>
<span class="nc" id="L189">            });</span>
<span class="nc" id="L190">    YPosition.textProperty()</span>
<span class="nc" id="L191">        .addListener(</span>
            (observable, oldValue, newValue) -&gt; {
<span class="nc" id="L193">              MoveButton.setDisable(</span>
<span class="nc bnc" id="L194" title="All 2 branches missed.">                  newValue.trim().isEmpty()</span>
<span class="nc bnc" id="L195" title="All 2 branches missed.">                      || XPosition.getText().isBlank()</span>
<span class="nc bnc" id="L196" title="All 2 branches missed.">                      || !coordinateChecker(XPosition.getText(), YPosition.getText()));</span>
<span class="nc" id="L197">            });</span>

<span class="nc" id="L199">    dialog.getDialogPane().setContent(grid);</span>

    // Convert the result to a username-password-pair when the login button is clicked.
<span class="nc" id="L202">    dialog.setResultConverter(</span>
        dialogButton -&gt; {
<span class="nc bnc" id="L204" title="All 2 branches missed.">          if (dialogButton == Move) {</span>
<span class="nc" id="L205">            double xCo = Double.parseDouble(XPosition.getText());</span>
<span class="nc" id="L206">            double yCo = Double.parseDouble(YPosition.getText());</span>
<span class="nc" id="L207">            double x = xCo - MAPWIDTH / 2;</span>
<span class="nc" id="L208">            double y = yCo - MAPHEIGHT / 2;</span>
<span class="nc" id="L209">            lastPressed.setTranslateX(x);</span>
<span class="nc" id="L210">            lastPressed.setTranslateY(y);</span>
          }
<span class="nc" id="L212">          return null;</span>
        });
<span class="nc" id="L214">    dialog.showAndWait();</span>
<span class="nc" id="L215">  }</span>

  // Must be called whenever an icon is added to the map
  private void updateLayoutChildren() {
<span class="nc" id="L219">    layout.getChildren().setAll(new ImageView(backgroundImage));</span>
<span class="nc bnc" id="L220" title="All 2 branches missed.">    for (MapEquipmentIcon icon : mapIconsByFloor.get(currFloor)) {</span>
<span class="nc" id="L221">      layout.getChildren().add(icon.getButton());</span>
<span class="nc" id="L222">    }</span>
<span class="nc bnc" id="L223" title="All 2 branches missed.">    for (MapLocationDot dot : locationsByFloor.get(currFloor)) {</span>
<span class="nc" id="L224">      layout.getChildren().add(dot.getIcon());</span>
<span class="nc" id="L225">    }</span>
<span class="nc bnc" id="L226" title="All 2 branches missed.">    for (MapServiceRequestIcon icon : ActiveSRByFloor.get(currFloor)) {</span>
<span class="nc bnc" id="L227" title="All 2 branches missed.">      if (!layout.getChildren().contains(icon.progressIndicator)) {</span>
<span class="nc" id="L228">        layout.getChildren().addAll(icon.progressIndicator, icon.Icon);</span>
      }
<span class="nc" id="L230">    }</span>
<span class="nc" id="L231">    updateRadialMenus();</span>
<span class="nc" id="L232">    createNewRadialMenus();</span>
<span class="nc bnc" id="L233" title="All 2 branches missed.">    for (RadialEquipmentMenu rm : radialMenusByFloor.get(currFloor)) {</span>
<span class="nc" id="L234">      layout.getChildren().add(rm.getButton());</span>
<span class="nc" id="L235">    }</span>
<span class="nc" id="L236">    showEquipmentRemovedFromRadialMenus();</span>
<span class="nc" id="L237">  }</span>

  // Init ScrollPane that holds the StackPane containing map and all Icons
  private ZoomableScrollPane createScrollPane(Pane layout) {
<span class="nc" id="L241">    ZoomableScrollPane scroll = new ZoomableScrollPane(layout);</span>
<span class="nc" id="L242">    scroll.setHbarPolicy(ScrollPane.ScrollBarPolicy.NEVER);</span>
<span class="nc" id="L243">    scroll.setVbarPolicy(ScrollPane.ScrollBarPolicy.NEVER);</span>
<span class="nc" id="L244">    scroll.setPannable(true);</span>
<span class="nc" id="L245">    scroll.setPrefSize(WIDTH, HEIGHT);</span>
<span class="nc" id="L246">    return scroll;</span>
  }

  // init ComboBox
  private JFXComboBox&lt;String&gt; createFloorSwitcher() {
<span class="nc" id="L251">    final JFXComboBox&lt;String&gt; comboBox = new JFXComboBox&lt;&gt;();</span>
<span class="nc" id="L252">    comboBox.setValue(currFloor.toString());</span>
<span class="nc bnc" id="L253" title="All 2 branches missed.">    for (FloorType floorType : FloorType.values()) {</span>
<span class="nc" id="L254">      comboBox.getItems().add(floorType.toString());</span>
    }
<span class="nc" id="L256">    comboBox.setTranslateX(Screen.getPrimary().getVisualBounds().getHeight() / 2.8);</span>
<span class="nc" id="L257">    comboBox.setTranslateY(-Screen.getPrimary().getVisualBounds().getHeight() / 2 + 10);</span>
<span class="nc" id="L258">    comboBox.setFocusColor(Color.rgb(0, 0, 255));</span>
<span class="nc" id="L259">    comboBox.setOnAction(</span>
        event -&gt; {
          try {
<span class="nc" id="L262">            switchFloors(FloorType.valueOf(comboBox.getValue()));</span>
<span class="nc" id="L263">          } catch (SQLException e) {</span>
<span class="nc" id="L264">            e.printStackTrace();</span>
<span class="nc" id="L265">          }</span>
<span class="nc" id="L266">        });</span>
<span class="nc" id="L267">    return comboBox;</span>
  }

  public String getImageResource(String filePath) {
<span class="nc" id="L271">    return Objects.requireNonNull(App.class.getResource(filePath)).toString();</span>
  }

  private JFXButton createZoomInButton() {
<span class="nc" id="L275">    Image zoomIcon = new Image(getImageResource(&quot;images/Icons/ZoomIn.png&quot;));</span>
<span class="nc" id="L276">    ImageView icon = new ImageView(zoomIcon);</span>
<span class="nc" id="L277">    icon.setFitWidth(30);</span>
<span class="nc" id="L278">    icon.setFitHeight(30);</span>
<span class="nc" id="L279">    final JFXButton zoomInButton = new JFXButton(&quot;&quot;, icon);</span>
<span class="nc" id="L280">    zoomInButton.setTranslateX(Screen.getPrimary().getVisualBounds().getHeight() / 1.45);</span>
<span class="nc" id="L281">    zoomInButton.setTranslateY(-Screen.getPrimary().getVisualBounds().getHeight() / 2 + 50);</span>
<span class="nc" id="L282">    zoomInButton.setOnAction(</span>
        (event) -&gt; {
          // double value zoomAmplifier is 1 for buttons
<span class="nc" id="L285">          zoomIn(1);</span>
<span class="nc" id="L286">        });</span>
<span class="nc" id="L287">    return zoomInButton;</span>
  }

  // Show all of the Equipment types passed in
  private void filter(EquipmentType e) {
<span class="nc bnc" id="L292" title="All 2 branches missed.">    for (MapEquipmentIcon mapIcon : mapIconsByFloor.get(currFloor)) {</span>
<span class="nc bnc" id="L293" title="All 2 branches missed.">      if (mapIcon.equipment.getType() == e) {</span>
<span class="nc bnc" id="L294" title="All 2 branches missed.">        mapIcon.getButton().setVisible(!mapIcon.getButton().isVisible());</span>
      }
<span class="nc" id="L296">    }</span>
<span class="nc" id="L297">  }</span>

  private ArrayList&lt;JFXCheckBox&gt; createFilterCheckBoxes() {
<span class="nc" id="L300">    ArrayList&lt;JFXCheckBox&gt; retval = new ArrayList&lt;&gt;();</span>

<span class="nc bnc" id="L302" title="All 2 branches missed.">    for (EquipmentType currEquipment : EquipmentType.values()) {</span>
<span class="nc" id="L303">      JFXCheckBox equipmentCheckBox = new JFXCheckBox(currEquipment.toString());</span>
<span class="nc" id="L304">      equipmentCheckBox.getStyleClass().add(&quot;combo-box&quot;);</span>

<span class="nc" id="L306">      equipmentCheckBox.setSelected(true);</span>
<span class="nc" id="L307">      equipmentCheckBox.setOnAction(event -&gt; filter(currEquipment));</span>
<span class="nc" id="L308">      retval.add(equipmentCheckBox);</span>
<span class="nc" id="L309">      equipmentCheckBox.setPrefWidth(30);</span>
<span class="nc" id="L310">      equipmentCheckBox.setPrefHeight(30);</span>
<span class="nc" id="L311">      equipmentCheckBox.setTranslateY(</span>
<span class="nc" id="L312">          -30 * currEquipment.ordinal() - Screen.getPrimary().getVisualBounds().getHeight() / 2.8);</span>
<span class="nc" id="L313">      equipmentCheckBox.setTranslateX(Screen.getPrimary().getVisualBounds().getWidth() / 3.4);</span>
    }

<span class="nc" id="L316">    JFXCheckBox locationsCheckBox = new JFXCheckBox(&quot;Location Dots&quot;);</span>
<span class="nc" id="L317">    locationsCheckBox.getStyleClass().add(&quot;combo-box&quot;);</span>
<span class="nc" id="L318">    locationsCheckBox.setSelected(true);</span>
<span class="nc" id="L319">    locationsCheckBox.setOnAction(</span>
        event -&gt; {
<span class="nc bnc" id="L321" title="All 2 branches missed.">          for (MapLocationDot dot : locationsByFloor.get(currFloor)) {</span>
<span class="nc bnc" id="L322" title="All 2 branches missed.">            dot.getIcon().setVisible(!dot.getIcon().isVisible());</span>
<span class="nc" id="L323">          }</span>
<span class="nc bnc" id="L324" title="All 2 branches missed.">          showLocationNodes = !showLocationNodes;</span>
<span class="nc" id="L325">        });</span>
<span class="nc" id="L326">    locationsCheckBox.setPrefHeight(30);</span>
<span class="nc" id="L327">    locationsCheckBox.setPrefWidth(30);</span>
<span class="nc" id="L328">    locationsCheckBox.setTranslateY(</span>
<span class="nc" id="L329">        -30 * retval.size() - Screen.getPrimary().getVisualBounds().getHeight() / 2.8);</span>
<span class="nc" id="L330">    locationsCheckBox.setTranslateX(Screen.getPrimary().getVisualBounds().getWidth() / 3.4);</span>
<span class="nc" id="L331">    retval.add(locationsCheckBox);</span>

<span class="nc" id="L333">    JFXCheckBox serviceRequestsCheckbox = new JFXCheckBox(&quot;Service Requests&quot;);</span>
<span class="nc" id="L334">    serviceRequestsCheckbox.getStyleClass().add(&quot;combo-box&quot;);</span>
<span class="nc" id="L335">    serviceRequestsCheckbox.setSelected(true);</span>
<span class="nc" id="L336">    serviceRequestsCheckbox.setOnAction(</span>
        event -&gt; {
<span class="nc bnc" id="L338" title="All 2 branches missed.">          for (MapServiceRequestIcon i : ActiveSRByFloor.get(currFloor)) {</span>
<span class="nc bnc" id="L339" title="All 2 branches missed.">            i.getIcon().setVisible(!i.getIcon().isVisible());</span>
<span class="nc" id="L340">            i.getFillProgressIndicator().setVisible(serviceRequestsCheckbox.isSelected());</span>
<span class="nc" id="L341">          }</span>
<span class="nc" id="L342">        });</span>
<span class="nc" id="L343">    serviceRequestsCheckbox.setPrefHeight(30);</span>
<span class="nc" id="L344">    serviceRequestsCheckbox.setPrefWidth(30);</span>
<span class="nc" id="L345">    serviceRequestsCheckbox.setTranslateY(</span>
<span class="nc" id="L346">        -30 * retval.size() - Screen.getPrimary().getVisualBounds().getHeight() / 2.8);</span>
<span class="nc" id="L347">    serviceRequestsCheckbox.setTranslateX(Screen.getPrimary().getVisualBounds().getWidth() / 3.4);</span>
<span class="nc" id="L348">    retval.add(serviceRequestsCheckbox);</span>

<span class="nc" id="L350">    return retval;</span>
  }

  private JFXButton createZoomOutButton() {
<span class="nc" id="L354">    Image zoomIcon = new Image(getImageResource(&quot;images/Icons/ZoomOut.png&quot;));</span>
<span class="nc" id="L355">    ImageView icon = new ImageView(zoomIcon);</span>
<span class="nc" id="L356">    icon.setFitWidth(30);</span>
<span class="nc" id="L357">    icon.setFitHeight(30);</span>
<span class="nc" id="L358">    final JFXButton zoomOutButton = new JFXButton(&quot;&quot;, icon);</span>
<span class="nc" id="L359">    zoomOutButton.setTranslateX(Screen.getPrimary().getVisualBounds().getHeight() / 1.45);</span>
<span class="nc" id="L360">    zoomOutButton.setTranslateY(-Screen.getPrimary().getVisualBounds().getHeight() / 2 + 10);</span>
<span class="nc" id="L361">    zoomOutButton.setOnAction(</span>
        (event) -&gt; {
          // double value zoomAmplifier is 1 for buttons
<span class="nc" id="L364">          zoomOut(1);</span>
<span class="nc" id="L365">        });</span>
<span class="nc" id="L366">    return zoomOutButton;</span>
  }

  private JFXButton createRefreshButton() {
<span class="nc" id="L370">    Image zoomIcon = new Image(getImageResource(&quot;images/Icons/RefreshIcon.png&quot;));</span>
<span class="nc" id="L371">    ImageView icon = new ImageView(zoomIcon);</span>
<span class="nc" id="L372">    icon.setFitWidth(30);</span>
<span class="nc" id="L373">    icon.setFitHeight(30);</span>
<span class="nc" id="L374">    final JFXButton zoomOutButton = new JFXButton(&quot;&quot;, icon);</span>
<span class="nc" id="L375">    zoomOutButton.setTranslateX(Screen.getPrimary().getVisualBounds().getHeight() / 1.45);</span>
<span class="nc" id="L376">    zoomOutButton.setTranslateY(-Screen.getPrimary().getVisualBounds().getHeight() / 2 + 90);</span>
<span class="nc" id="L377">    zoomOutButton.setOnAction(</span>
        (event) -&gt; {
          try {
<span class="nc" id="L380">            RefreshSRfromDB();</span>
<span class="nc" id="L381">          } catch (SQLException e) {</span>
<span class="nc" id="L382">            e.printStackTrace();</span>
<span class="nc" id="L383">          }</span>
<span class="nc" id="L384">        });</span>
<span class="nc" id="L385">    return zoomOutButton;</span>
  }

  // Catch-all zoomOut method
  private void zoomOut(double amp) {
<span class="nc" id="L390">    amp /= 10; // amp must be low so that the image does not scale too far</span>
<span class="nc bnc" id="L391" title="All 2 branches missed.">    if (layout.getScaleX() &gt; ZOOMOUTMAX) {</span>
<span class="nc" id="L392">      layout.setScaleX(layout.getScaleX() * 1 / (1 + amp));</span>
<span class="nc" id="L393">      layout.setScaleY(layout.getScaleY() * 1 / (1 + amp));</span>
    }
<span class="nc" id="L395">  }</span>

  // Catch-all zoomIn method
  private void zoomIn(double amp) {
<span class="nc" id="L399">    amp /= 10; // amp must be low so that the image does not scale too far</span>
<span class="nc bnc" id="L400" title="All 2 branches missed.">    if (layout.getScaleX() &lt; ZOOMINMAX) {</span>
<span class="nc" id="L401">      layout.setScaleX(layout.getScaleX() * (1 + amp));</span>
<span class="nc" id="L402">      layout.setScaleY(layout.getScaleY() * (1 + amp));</span>
    }
<span class="nc" id="L404">  }</span>

  public Parent getMapScene(double height, double width) throws SQLException {
    // Load Icon Graphics
<span class="nc bnc" id="L408" title="All 2 branches missed.">    for (EquipmentType currEquip : EquipmentType.values()) {</span>
<span class="nc" id="L409">      TypeGraphics.put(</span>
          currEquip,
          new Image(
<span class="nc" id="L412">              App.class.getResource(currEquip.getResource()).toString(),</span>
              20.0,
              20.0,
              true,
              true,
              true));
    }
<span class="nc" id="L419">    System.out.println(&quot;Icons Graphics Load&quot;);</span>
    // Creating OnClickPane Menu
<span class="nc" id="L421">    PaneMenu.getStyleClass().add(&quot;combo-box&quot;);</span>
<span class="nc bnc" id="L422" title="All 2 branches missed.">    for (EquipmentType currEquipment : EquipmentType.values()) {</span>
<span class="nc" id="L423">      PaneMenu.getItems().add(createEquipmentMenuItem(currEquipment));</span>
    }
    // Creating Equipment Icon Pressed
<span class="nc" id="L426">    EquipmentClicked.getStyleClass().add(&quot;combo-box&quot;);</span>
<span class="nc" id="L427">    MenuItem deleteMenuItem = new MenuItem(&quot;Delete&quot;);</span>
<span class="nc" id="L428">    deleteMenuItem.setOnAction(</span>
        event -&gt; {
<span class="nc" id="L430">          deleteMapIcon(lastPressed);</span>
<span class="nc" id="L431">          updateLayoutChildren();</span>
<span class="nc" id="L432">        });</span>
<span class="nc" id="L433">    MenuItem addMenuItem = new MenuItem(&quot;Edit&quot;);</span>
<span class="nc" id="L434">    addMenuItem.setOnAction(</span>
        event -&gt; {
<span class="nc" id="L436">          showEditLastPressedDialog();</span>
<span class="nc" id="L437">        });</span>
<span class="nc" id="L438">    EquipmentClicked.getItems().addAll(deleteMenuItem, addMenuItem);</span>
<span class="nc" id="L439">    updateLayoutChildren();</span>
<span class="nc" id="L440">    layout.setScaleX(.5);</span>
<span class="nc" id="L441">    layout.setScaleY(.5);</span>
    // TODO
<span class="nc" id="L443">    ZoomableScrollPane scroll = createScrollPane(layout);</span>
<span class="nc" id="L444">    StackPane staticWrapper = new StackPane();</span>
<span class="nc" id="L445">    layout.setOnScroll(</span>
<span class="nc" id="L446">        new EventHandler&lt;ScrollEvent&gt;() {</span>
          @Override
          public void handle(ScrollEvent event) {
<span class="nc" id="L449">            scroll.zoomNode.fireEvent(event);</span>
<span class="nc" id="L450">          }</span>
        });
<span class="nc" id="L452">    staticWrapper</span>
<span class="nc" id="L453">        .getChildren()</span>
<span class="nc" id="L454">        .setAll(</span>
            scroll,
<span class="nc" id="L456">            createZoomInButton(),</span>
<span class="nc" id="L457">            createZoomOutButton(),</span>
<span class="nc" id="L458">            createFloorSwitcher(),</span>
<span class="nc" id="L459">            createRefreshButton());</span>
<span class="nc" id="L460">    staticWrapper.getChildren().addAll(createFilterCheckBoxes());</span>
    // setting size of scroll pane and setting the bar values
<span class="nc" id="L462">    scroll.setPrefSize(width, height);</span>
<span class="nc" id="L463">    scroll.setHvalue(scroll.getHmin() + (scroll.getHmax() - scroll.getHmin()) / 2);</span>
<span class="nc" id="L464">    scroll.setVvalue(scroll.getVmin() + (scroll.getVmax() - scroll.getVmin()) / 2);</span>
    //    layout.setOnMouseReleased(
    //        event -&gt; {
    //          if (event.getButton() == MouseButton.SECONDARY) {
    //            // In Pixel Coordinates
    //            lastPressedPoint = layout.sceneToLocal(event.getSceneX(), event.getSceneY());
    //            scroll.setContextMenu(PaneMenu);
    //            PaneMenu.show(scroll, event.getScreenX(), event.getScreenY());
    //          }
    //        });
<span class="nc" id="L474">    layout.setOnMouseMoved(this::closeRadialMenus);</span>
<span class="nc" id="L475">    System.out.println(&quot;Init Complete&quot;);</span>
<span class="nc" id="L476">    Navigation = new PathFinder(layout, backgroundImage.getWidth(), backgroundImage.getHeight());</span>
<span class="nc" id="L477">    return staticWrapper;</span>
  }

  private MapEquipmentIcon addEquipmentToMap(Equipment equipment) {
<span class="nc" id="L481">    final JFXButton Icon = new JFXButton(); // Create new button</span>
<span class="nc" id="L482">    Icon.setOpacity(.85);</span>
<span class="nc" id="L483">    ImageView newGraphic = new ImageView();</span>
<span class="nc" id="L484">    newGraphic.setImage(TypeGraphics.get(equipment.getType()));</span>

<span class="nc" id="L486">    Icon.setGraphic(newGraphic); // Set Graphic to Equipment Type</span>
<span class="nc" id="L487">    Icon.setTranslateX(</span>
<span class="nc" id="L488">        equipment.getLocation().getX()</span>
            - MAPWIDTH / 2); // Convert to Translate Coordinates and set X
<span class="nc" id="L490">    Icon.setTranslateY(equipment.getLocation().getY() - MAPHEIGHT / 2); // ^^ with y</span>
    // Set Context Menu
<span class="nc" id="L492">    Icon.setContextMenu(EquipmentClicked);</span>
    // Set Context Menu to Show
<span class="nc" id="L494">    Icon.setOnMouseClicked(</span>
<span class="nc" id="L495">        new EventHandler&lt;MouseEvent&gt;() {</span>
          @Override
          public void handle(MouseEvent event) {
            // Set last pressed button
<span class="nc" id="L499">            lastPressed = Icon;</span>
<span class="nc" id="L500">            Icon.getContextMenu().show(Icon, event.getScreenX(), event.getScreenY());</span>
<span class="nc" id="L501">          }</span>
        });
<span class="nc" id="L503">    Tooltip tooltip = new Tooltip(equipment.getName());</span>
<span class="nc" id="L504">    Tooltip.install(Icon, tooltip);</span>
<span class="nc" id="L505">    MapEquipmentIcon newMapIcon = new MapEquipmentIcon(Icon, equipment);</span>
<span class="nc" id="L506">    draggable(newMapIcon);</span>
<span class="nc" id="L507">    mapIconsByFloor.get(equipment.getLocation().getFloor()).add(newMapIcon);</span>
<span class="nc" id="L508">    updateLayoutChildren();</span>
<span class="nc" id="L509">    return newMapIcon;</span>
  }

  private void draggable(MapEquipmentIcon i) {
<span class="nc" id="L513">    JFXButton node = i.getButton();</span>
<span class="nc" id="L514">    final Position startingPosition = new Position();</span>

    // Prompt the user that the node can be clicked
<span class="nc" id="L517">    node.addEventHandler(</span>
        MouseEvent.MOUSE_ENTERED,
        event -&gt; {
<span class="nc" id="L520">          node.setCursor(Cursor.HAND);</span>
<span class="nc" id="L521">        });</span>
<span class="nc" id="L522">    node.addEventHandler(</span>
        MouseEvent.MOUSE_EXITED,
        event -&gt; {
<span class="nc" id="L525">          node.setCursor(Cursor.DEFAULT);</span>
<span class="nc" id="L526">        });</span>

    // Prompt the user that the node can be dragged
<span class="nc" id="L529">    node.addEventHandler(</span>
        MouseEvent.MOUSE_PRESSED,
        event -&gt; {
<span class="nc bnc" id="L532" title="All 2 branches missed.">          if (event.getButton() == MouseButton.PRIMARY) {</span>
<span class="nc" id="L533">            System.out.println(&quot;Started drag&quot;);</span>
<span class="nc bnc" id="L534" title="All 2 branches missed.">            for (MapLocationDot dot : locationsByFloor.get(currFloor)) {</span>
<span class="nc" id="L535">              dot.getIcon().setVisible(true);</span>
<span class="nc" id="L536">            }</span>
<span class="nc" id="L537">            node.setCursor(Cursor.MOVE);</span>
            // When a press event occurs, the location coordinates of the event are cached
<span class="nc" id="L539">            startingPosition.x = node.getTranslateX();</span>
<span class="nc" id="L540">            startingPosition.y = node.getTranslateY();</span>
<span class="nc" id="L541">            System.out.println(startingPosition.x + &quot; &quot; + startingPosition.y);</span>
<span class="nc" id="L542">            System.out.println(startingPosition.x + &quot; &quot; + startingPosition.y);</span>
          }
<span class="nc" id="L544">        });</span>
<span class="nc" id="L545">    node.addEventHandler(</span>
        MouseEvent.MOUSE_RELEASED,
        event -&gt; {
<span class="nc" id="L548">          Point2D updatedLocation =</span>
<span class="nc" id="L549">              layout.sceneToLocal(new Point2D(event.getSceneX(), event.getSceneY()));</span>
<span class="nc" id="L550">          Location nearestLocation =</span>
<span class="nc" id="L551">              getClosestLocation(updatedLocation.getX(), updatedLocation.getY());</span>
<span class="nc bnc" id="L552" title="All 2 branches missed.">          if (nearestLocation == null) {</span>
<span class="nc" id="L553">            System.out.println(&quot;No node close enough to snap.&quot;);</span>
<span class="nc" id="L554">            node.setTranslateX(startingPosition.x);</span>
<span class="nc" id="L555">            node.setTranslateY(startingPosition.y);</span>
          } else {
<span class="nc" id="L557">            System.out.println(&quot;Snapping to nearest node.&quot;);</span>
<span class="nc" id="L558">            node.setTranslateX(nearestLocation.getX() - MAPWIDTH / 2);</span>
<span class="nc" id="L559">            node.setTranslateY(nearestLocation.getY() - MAPHEIGHT / 2);</span>
<span class="nc" id="L560">            i.getEquipment().setLocation(nearestLocation);</span>

            try {
<span class="nc" id="L563">              DBManager.getInstance()</span>
<span class="nc" id="L564">                  .getManager(DataBaseObjectType.Equipment)</span>
<span class="nc" id="L565">                  .update(i.getEquipment());</span>
<span class="nc" id="L566">            } catch (SQLException e) {</span>
<span class="nc" id="L567">              e.printStackTrace();</span>
<span class="nc" id="L568">            }</span>
            // AutoFill
            MedicalEquipmentDeliveryServiceRequestPageServiceRequestController
<span class="nc" id="L571">                medicalEquipmentSRController =</span>
                    (MedicalEquipmentDeliveryServiceRequestPageServiceRequestController)
                        ServiceRequestDirectoryPageController.medicalEquipmentSRTab.controller;

<span class="nc" id="L575">            medicalEquipmentSRController.equipment.setText(i.getEquipment().getName());</span>
<span class="nc" id="L576">            medicalEquipmentSRController.requestDate.setValue(LocalDate.now());</span>
<span class="nc" id="L577">            medicalEquipmentSRController.locationText.setText(</span>
<span class="nc" id="L578">                i.getEquipment().getLocation().getLongName());</span>
<span class="nc" id="L579">            medicalEquipmentSRController.status.setValue(ServiceRequestStatus.OPEN);</span>
<span class="nc" id="L580">            medicalEquipmentSRController.priority.setValue(ServiceRequestPriority.Normal);</span>

<span class="nc" id="L582">            System.out.println(&quot;Done&quot;);</span>
<span class="nc" id="L583">            node.setCursor(Cursor.DEFAULT);</span>

<span class="nc bnc" id="L585" title="All 2 branches missed.">            if (!showLocationNodes) {</span>
<span class="nc" id="L586">              System.out.println(&quot;Hiding location nodes.&quot;);</span>
<span class="nc bnc" id="L587" title="All 2 branches missed.">              for (MapLocationDot dot : locationsByFloor.get(currFloor)) {</span>
<span class="nc" id="L588">                dot.getIcon().setVisible(false);</span>
<span class="nc" id="L589">              }</span>
            }
<span class="nc" id="L591">            updateLayoutChildren();</span>

<span class="nc bnc" id="L593" title="All 2 branches missed.">            for (RadialEquipmentMenu rm : radialMenusByFloor.get(currFloor)) {</span>
<span class="nc" id="L594">              rm.hide();</span>
<span class="nc" id="L595">            }</span>
          }
<span class="nc" id="L597">        });</span>

    // Realize drag and drop function
<span class="nc" id="L600">    node.addEventHandler(</span>
        MouseEvent.MOUSE_DRAGGED,
        event -&gt; {
<span class="nc bnc" id="L603" title="All 2 branches missed.">          if (event.getButton() == MouseButton.PRIMARY) {</span>
<span class="nc" id="L604">            Point2D updatedLocation =</span>
<span class="nc" id="L605">                layout.sceneToLocal(new Point2D(event.getSceneX(), event.getSceneY()));</span>
<span class="nc" id="L606">            double x = updatedLocation.getX() - MAPWIDTH / 2;</span>
<span class="nc" id="L607">            double y = updatedLocation.getY() - MAPHEIGHT / 2;</span>
<span class="nc" id="L608">            node.setTranslateX(x);</span>
<span class="nc" id="L609">            node.setTranslateY(y);</span>
          }
<span class="nc" id="L611">        });</span>
<span class="nc" id="L612">  }</span>

  private Location getClosestLocation(double x, double y) {
<span class="nc" id="L615">    Location closestLocation = null;</span>
<span class="nc" id="L616">    double closestDistance = Double.MAX_VALUE;</span>
<span class="nc bnc" id="L617" title="All 2 branches missed.">    for (MapLocationDot dot : locationsByFloor.get(currFloor)) {</span>
<span class="nc" id="L618">      Location l = dot.getLocation();</span>
<span class="nc" id="L619">      double d = dot.getDistanceToLocation(x, y);</span>
<span class="nc bnc" id="L620" title="All 2 branches missed.">      if (d &lt; closestDistance) {</span>
<span class="nc" id="L621">        closestDistance = d;</span>
<span class="nc" id="L622">        closestLocation = l;</span>
      }
<span class="nc" id="L624">    }</span>
<span class="nc bnc" id="L625" title="All 2 branches missed.">    if (closestDistance &gt; 50) {</span>
<span class="nc" id="L626">      return null;</span>
    }
<span class="nc" id="L628">    return closestLocation;</span>
  }

  public void getFromDB() throws SQLException {
    List&lt;Equipment&gt; equipment =
<span class="nc" id="L633">        DBManager.getInstance().getManager(DataBaseObjectType.Equipment).getAll();</span>
<span class="nc" id="L634">    mapIconsByFloor.get(currFloor).clear();</span>
<span class="nc" id="L635">    locationsByFloor.get(currFloor).clear();</span>
<span class="nc bnc" id="L636" title="All 2 branches missed.">    for (Equipment currEquipment : equipment) {</span>
<span class="nc" id="L637">      addEquipmentToMap(currEquipment);</span>
<span class="nc" id="L638">    }</span>

    List&lt;Location&gt; locations =
<span class="nc" id="L641">        DBManager.getInstance().getManager(DataBaseObjectType.Location).getAll();</span>
<span class="nc bnc" id="L642" title="All 2 branches missed.">    for (Location currLocation : locations) {</span>
<span class="nc" id="L643">      locationToMapElement(currLocation);</span>
<span class="nc" id="L644">    }</span>
<span class="nc" id="L645">    Navigation.refreshLocationsFromDB();</span>
<span class="nc" id="L646">    Navigation.createConnections();</span>
<span class="nc" id="L647">  }</span>

  public void RefreshSRfromDB() throws SQLException {
<span class="nc" id="L650">    ArrayList&lt;ServiceRequest&gt; serviceRequestsFromDB = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L651">    serviceRequestsFromDB.addAll(</span>
<span class="nc" id="L652">        DBManager.getInstance().getManager(DataBaseObjectType.AudioVisualSR).getAll());</span>
<span class="nc" id="L653">    serviceRequestsFromDB.addAll(</span>
<span class="nc" id="L654">        DBManager.getInstance().getManager(DataBaseObjectType.ComputerSR).getAll());</span>
<span class="nc" id="L655">    serviceRequestsFromDB.addAll(</span>
<span class="nc" id="L656">        DBManager.getInstance().getManager(DataBaseObjectType.FoodDeliverySR).getAll());</span>
<span class="nc" id="L657">    serviceRequestsFromDB.addAll(</span>
<span class="nc" id="L658">        DBManager.getInstance().getManager(DataBaseObjectType.GiftAndFloralSR).getAll());</span>
<span class="nc" id="L659">    serviceRequestsFromDB.addAll(</span>
<span class="nc" id="L660">        DBManager.getInstance().getManager(DataBaseObjectType.InternalPatientTransferSR).getAll());</span>
<span class="nc" id="L661">    serviceRequestsFromDB.addAll(</span>
<span class="nc" id="L662">        DBManager.getInstance().getManager(DataBaseObjectType.ExternalPatientSR).getAll());</span>
<span class="nc" id="L663">    serviceRequestsFromDB.addAll(</span>
<span class="nc" id="L664">        DBManager.getInstance().getManager(DataBaseObjectType.LanguageInterpreterSR).getAll());</span>
<span class="nc" id="L665">    serviceRequestsFromDB.addAll(</span>
<span class="nc" id="L666">        DBManager.getInstance().getManager(DataBaseObjectType.LaundrySR).getAll());</span>
<span class="nc" id="L667">    serviceRequestsFromDB.addAll(</span>
<span class="nc" id="L668">        DBManager.getInstance().getManager(DataBaseObjectType.ReligiousSR).getAll());</span>
<span class="nc" id="L669">    serviceRequestsFromDB.addAll(</span>
<span class="nc" id="L670">        DBManager.getInstance().getManager(DataBaseObjectType.SecuritySR).getAll());</span>
<span class="nc" id="L671">    serviceRequestsFromDB.addAll(</span>
<span class="nc" id="L672">        DBManager.getInstance().getManager(DataBaseObjectType.MedicalEquipmentSR).getAll());</span>
<span class="nc" id="L673">    serviceRequestsFromDB.addAll(</span>
<span class="nc" id="L674">        DBManager.getInstance().getManager(DataBaseObjectType.MedicineDeliverySR).getAll());</span>
<span class="nc" id="L675">    serviceRequestsFromDB.addAll(</span>
<span class="nc" id="L676">        DBManager.getInstance().getManager(DataBaseObjectType.FacilitiesMaintenanceSR).getAll());</span>
<span class="nc" id="L677">    serviceRequestsFromDB.addAll(</span>
<span class="nc" id="L678">        DBManager.getInstance().getManager(DataBaseObjectType.SanitationSR).getAll());</span>
<span class="nc" id="L679">    serviceRequestsFromDB.stream()</span>
<span class="nc" id="L680">        .forEach(</span>
            serviceRequest -&gt; {
<span class="nc bnc" id="L682" title="All 2 branches missed.">              if (oldSR.contains(serviceRequest)) {</span>
<span class="nc" id="L683">                serviceRequestsFromDB.remove(serviceRequest);</span>
              } else {
<span class="nc" id="L685">                oldSR.add(serviceRequest);</span>
                try {
<span class="nc" id="L687">                  ServiceRequestToMapElement(serviceRequest);</span>
<span class="nc bnc" id="L688" title="All 2 branches missed.">                  if (serviceRequest.getDBType() == DataBaseObjectType.MedicalEquipmentSR) {</span>
<span class="nc" id="L689">                    MedicalEquipmentServiceRequest newSr =</span>
                        (MedicalEquipmentServiceRequest) serviceRequest;
<span class="nc" id="L691">                    List&lt;Location&gt; routeSnap =</span>
<span class="nc" id="L692">                        Navigation.FindAndDrawRoute(</span>
<span class="nc" id="L693">                            newSr.getEquipment().getLocation().getId(),</span>
<span class="nc" id="L694">                            newSr.getLocation().getId(),</span>
                            Color.BLUE);
<span class="nc" id="L696">                    Timer newTimer = new Timer();</span>
<span class="nc" id="L697">                    mapIconsByFloor</span>
<span class="nc" id="L698">                        .get(newSr.getLocation().getFloor())</span>
<span class="nc" id="L699">                        .forEach(</span>
                            icon -&gt; {
<span class="nc bnc" id="L701" title="All 2 branches missed.">                              if (newSr.getEquipment().getId() == icon.getEquipment().getId()) {</span>
<span class="nc" id="L702">                                System.out.println(&quot;Found Equipment&quot;);</span>
<span class="nc" id="L703">                                int period = (int) 20 * 1000 / routeSnap.size();</span>
<span class="nc" id="L704">                                final int[] counter = {0};</span>
<span class="nc" id="L705">                                newTimer.scheduleAtFixedRate(</span>
<span class="nc" id="L706">                                    new TimerTask() {</span>
                                      @Override
                                      public void run() {
<span class="nc" id="L709">                                        Platform.runLater(</span>
<span class="nc" id="L710">                                            new Runnable() {</span>
                                              @Override
                                              public void run() {
<span class="nc bnc" id="L713" title="All 2 branches missed.">                                                if (counter[0] &gt; routeSnap.size() - 1) {</span>
<span class="nc" id="L714">                                                  Navigation.RemoveRoute();</span>
<span class="nc" id="L715">                                                  newTimer.cancel();</span>
                                                }
<span class="nc bnc" id="L717" title="All 2 branches missed.">                                                if (counter[0] &lt;= routeSnap.size() - 1) {</span>
<span class="nc" id="L718">                                                  icon.getButton()</span>
<span class="nc" id="L719">                                                      .setTranslateX(</span>
<span class="nc" id="L720">                                                          routeSnap.get(counter[0]).getX()</span>
                                                              - MAPWIDTH / 2);
<span class="nc" id="L722">                                                  icon.getButton()</span>
<span class="nc" id="L723">                                                      .setTranslateY(</span>
<span class="nc" id="L724">                                                          routeSnap.get(counter[0]).getY()</span>
                                                              - MAPHEIGHT / 2);
<span class="nc" id="L726">                                                  newSr</span>
<span class="nc" id="L727">                                                      .getEquipment()</span>
<span class="nc" id="L728">                                                      .setLocation(routeSnap.get(counter[0]));</span>
                                                  try {
<span class="nc" id="L730">                                                    DBManager.getInstance()</span>
<span class="nc" id="L731">                                                        .getManager(DataBaseObjectType.Equipment)</span>
<span class="nc" id="L732">                                                        .update(newSr.getEquipment());</span>
<span class="nc" id="L733">                                                  } catch (SQLException e) {</span>
<span class="nc" id="L734">                                                    e.printStackTrace();</span>
<span class="nc" id="L735">                                                  }</span>
                                                }
<span class="nc" id="L737">                                              }</span>
                                            });

                                        //                                        try {
                                        //                                          Location newL =
                                        //
                                        // routeSnap.get(routeSnap.size() - 1);
                                        //                                          Equipment newE =
                                        // newSr.getEquipment();
                                        //
                                        // newE.setLocation(newL);
                                        //
                                        // DBManager.getInstance().getManager(
                                        //
                                        // DataBaseObjectType.Equipment)
                                        //
                                        // .update(newE);
                                        //                                        } catch
                                        // (SQLException e) {
                                        //
                                        // e.printStackTrace();
                                        //                                        }
<span class="nc" id="L759">                                        counter[0]++;</span>
<span class="nc" id="L760">                                      }</span>
                                    },
                                    0,
                                    period);
                              }
<span class="nc" id="L765">                            });</span>
                  }
<span class="nc" id="L767">                } catch (SQLException e) {</span>
<span class="nc" id="L768">                  e.printStackTrace();</span>
<span class="nc" id="L769">                }</span>
              }
<span class="nc" id="L771">            });</span>
<span class="nc" id="L772">  }</span>

  private void locationToMapElement(Location location) {
<span class="nc" id="L775">    double mapWidthTest = Images.get(location.getFloor()).getWidth();</span>
<span class="nc" id="L776">    double mapHeightTest = Images.get(location.getFloor()).getHeight();</span>
<span class="nc" id="L777">    double x = location.getX() - mapWidthTest / 2;</span>
<span class="nc" id="L778">    double y = location.getY() - mapHeightTest / 2;</span>
<span class="nc" id="L779">    MapLocationDot newDot = new MapLocationDot(location, x, y);</span>
<span class="nc" id="L780">    locationsByFloor.get(location.getFloor()).add(newDot);</span>
<span class="nc" id="L781">    Tooltip t = new Tooltip(location.getLongName() + x + y);</span>
<span class="nc" id="L782">    Tooltip.install(newDot.getIcon(), t);</span>
<span class="nc" id="L783">    updateLayoutChildren();</span>
<span class="nc" id="L784">    newDot</span>
<span class="nc" id="L785">        .getIcon()</span>
<span class="nc" id="L786">        .setOnMouseClicked(</span>
<span class="nc" id="L787">            new EventHandler&lt;MouseEvent&gt;() {</span>
              @Override
              public void handle(MouseEvent event) {
<span class="nc" id="L790">                System.out.println(&quot;Node Pressed: &quot; + location.getId());</span>
<span class="nc bnc" id="L791" title="All 2 branches missed.">                if (event.getButton() == MouseButton.SECONDARY) {</span>
<span class="nc" id="L792">                  lastPressedLocation = location;</span>
<span class="nc" id="L793">                  PaneMenu.show(newDot.getIcon(), event.getScreenX(), event.getScreenY());</span>
<span class="nc bnc" id="L794" title="All 2 branches missed.">                } else if (PathFindingLocations.size() &lt; 2) {</span>
<span class="nc" id="L795">                  newDot.getIcon().setFill(Color.BLUE);</span>
<span class="nc" id="L796">                  PathFindingLocations.add(newDot);</span>
<span class="nc bnc" id="L797" title="All 2 branches missed.">                  if (PathFindingLocations.size() == 2) {</span>
                    try {
<span class="nc" id="L799">                      PathFindingLocations.get(0).getIcon().setFill(Color.YELLOW);</span>
<span class="nc" id="L800">                      PathFindingLocations.get(1).getIcon().setFill(Color.GREEN);</span>
<span class="nc" id="L801">                      Navigation.FindAndDrawRoute(</span>
<span class="nc" id="L802">                          PathFindingLocations.get(0).getLocation().getId(),</span>
<span class="nc" id="L803">                          PathFindingLocations.get(1).getLocation().getId(),</span>
                          Color.BLACK);

<span class="nc" id="L806">                    } catch (SQLException e) {</span>
<span class="nc" id="L807">                      e.printStackTrace();</span>
<span class="nc" id="L808">                    } catch (IllegalStateException e) {</span>
                      try {
<span class="nc" id="L810">                        PathFindingLocations.get(1).getIcon().setFill(Color.YELLOW);</span>
<span class="nc" id="L811">                        PathFindingLocations.get(0).getIcon().setFill(Color.GREEN);</span>
<span class="nc" id="L812">                        Navigation.FindAndDrawRoute(</span>
<span class="nc" id="L813">                            PathFindingLocations.get(1).getLocation().getId(),</span>
<span class="nc" id="L814">                            PathFindingLocations.get(0).getLocation().getId());</span>
<span class="nc" id="L815">                      } catch (SQLException ex) {</span>
<span class="nc" id="L816">                        ex.printStackTrace();</span>
<span class="nc" id="L817">                      }</span>
<span class="nc" id="L818">                    }</span>
                  }
<span class="nc bnc" id="L820" title="All 2 branches missed.">                } else if (PathFindingLocations.size() == 2) {</span>
<span class="nc" id="L821">                  Navigation.RemoveRoute();</span>
<span class="nc" id="L822">                  PathFindingLocations.stream()</span>
<span class="nc" id="L823">                      .forEach(</span>
                          LocationDot -&gt; {
<span class="nc" id="L825">                            LocationDot.getIcon().setFill(Color.BLACK);</span>
<span class="nc" id="L826">                          });</span>
<span class="nc" id="L827">                  PathFindingLocations.clear();</span>
<span class="nc" id="L828">                  PathFindingLocations.add(newDot);</span>
<span class="nc" id="L829">                  newDot.getIcon().setFill(Color.BLUE);</span>
                }
<span class="nc" id="L831">              }</span>
            });
<span class="nc" id="L833">  }</span>

  private void ServiceRequestToMapElement(ServiceRequest SR) throws SQLException {
<span class="nc" id="L836">    double X = SR.getLocation().getX() - MAPWIDTH / 2;</span>
<span class="nc" id="L837">    double Y = SR.getLocation().getY() - MAPHEIGHT / 2;</span>
<span class="nc" id="L838">    MapServiceRequestIcon newIcon = new MapServiceRequestIcon(SR, X, Y);</span>
<span class="nc" id="L839">    newIcon.addToList(ActiveSRByFloor.get(currFloor));</span>
<span class="nc" id="L840">    newIcon.startTimer(20);</span>
<span class="nc" id="L841">    updateLayoutChildren();</span>

<span class="nc" id="L843">    ContextMenu ServiceRequestMenu = new ContextMenu();</span>
<span class="nc" id="L844">    ServiceRequestMenu.setStyle(</span>
        &quot;-fx-background-color: linear-gradient(from 25% 25% to 100% 100%, #7579ff, #b224ef); -fx-background-radius: 10px; -fx-effect: dropshadow(three-pass-box, rgba(0,0,0,0.8), 10, 0, 0, 0)&quot;);
<span class="nc" id="L846">    RadioMenuItem CompleteServiceRequest = new RadioMenuItem(&quot;Complete Service Request&quot;);</span>
<span class="nc" id="L847">    RadioMenuItem UpdateServiceRequest = new RadioMenuItem(&quot;Update Service Request&quot;);</span>
<span class="nc" id="L848">    AutoCompleteTextField LocationField = new AutoCompleteTextField();</span>
<span class="nc" id="L849">    AutoCompleteTextField AssigneeServiceRequest = new AutoCompleteTextField();</span>
<span class="nc" id="L850">    CustomMenuItem Assignee = new CustomMenuItem(AssigneeServiceRequest);</span>
<span class="nc" id="L851">    CustomMenuItem Location = new CustomMenuItem(LocationField);</span>
<span class="nc" id="L852">    ((LocationManager) DBManager.getInstance().getManager(DataBaseObjectType.Location))</span>
<span class="nc" id="L853">        .getAll()</span>
<span class="nc" id="L854">        .forEach(</span>
            location -&gt; {
<span class="nc" id="L856">              LocationField.getEntries().add(location.getLongName());</span>
<span class="nc" id="L857">            });</span>
<span class="nc" id="L858">    ((EmployeeManager) DBManager.getInstance().getManager(DataBaseObjectType.Employee))</span>
<span class="nc" id="L859">        .getAll()</span>
<span class="nc" id="L860">        .forEach(</span>
            employee -&gt; {
<span class="nc" id="L862">              AssigneeServiceRequest.getEntries().add(employee.getName());</span>
<span class="nc" id="L863">            });</span>
<span class="nc" id="L864">    UpdateServiceRequest.setSelected(false);</span>
<span class="nc" id="L865">    UpdateServiceRequest.setOnAction(</span>
<span class="nc" id="L866">        new EventHandler&lt;ActionEvent&gt;() {</span>
          @Override
          public void handle(ActionEvent event) {
            try {
              Location newLocation =
                  ((LocationManager)
<span class="nc" id="L872">                          DBManager.getInstance().getManager(DataBaseObjectType.Location))</span>
<span class="nc" id="L873">                      .getByName(LocationField.getText());</span>
              Employee newEmployee =
                  ((EmployeeManager)
<span class="nc" id="L876">                          DBManager.getInstance().getManager(DataBaseObjectType.Employee))</span>
<span class="nc" id="L877">                      .getByAssignee(AssigneeServiceRequest.getText());</span>
<span class="nc bnc" id="L878" title="All 2 branches missed.">              if (newLocation != null) {</span>
<span class="nc" id="L879">                SR.setLocation(newLocation);</span>
<span class="nc" id="L880">                newIcon.Icon.setTranslateX(newLocation.getX() - MAPWIDTH / 2);</span>
<span class="nc" id="L881">                newIcon.Icon.setTranslateY(newLocation.getY() - MAPHEIGHT / 2);</span>
<span class="nc" id="L882">                newIcon.progressIndicator.setTranslateX(newIcon.Icon.getTranslateX());</span>
<span class="nc" id="L883">                newIcon.progressIndicator.setTranslateY(newIcon.Icon.getTranslateY());</span>
<span class="nc" id="L884">                System.out.println(</span>
<span class="nc" id="L885">                    &quot;Updated Service Request Location to:&quot; + SR.getLocation().getLongName());</span>
              }
<span class="nc bnc" id="L887" title="All 2 branches missed.">              if (newEmployee != null) {</span>
<span class="nc" id="L888">                SR.setAssignee(newEmployee);</span>
<span class="nc" id="L889">                System.out.println(</span>
<span class="nc" id="L890">                    &quot;Updated Service Request Assignee to: &quot; + SR.getAssignee().getName());</span>
              }
<span class="nc" id="L892">            } catch (SQLException e) {</span>
<span class="nc" id="L893">              e.printStackTrace();</span>
<span class="nc" id="L894">            }</span>

            try {
<span class="nc" id="L897">              DBManager.getInstance().getManager(SR.getDBType()).update(SR);</span>
<span class="nc" id="L898">            } catch (SQLException e) {</span>
<span class="nc" id="L899">              e.printStackTrace();</span>
<span class="nc" id="L900">            }</span>
<span class="nc" id="L901">          }</span>
        });
<span class="nc" id="L903">    CompleteServiceRequest.setOnAction(</span>
<span class="nc" id="L904">        new EventHandler&lt;ActionEvent&gt;() {</span>
          @Override
          public void handle(ActionEvent event) {
<span class="nc" id="L907">            newIcon.cancelTimer();</span>
<span class="nc" id="L908">            CompleteServiceRequest.setSelected(true);</span>
<span class="nc" id="L909">          }</span>
        });
<span class="nc" id="L911">    Location.setHideOnClick(false);</span>
<span class="nc" id="L912">    Assignee.setHideOnClick(false);</span>
<span class="nc" id="L913">    CompleteServiceRequest.setSelected(false);</span>
<span class="nc" id="L914">    ServiceRequestMenu.getItems().add(Assignee);</span>
<span class="nc" id="L915">    ServiceRequestMenu.getItems().add(Location);</span>
<span class="nc" id="L916">    ServiceRequestMenu.getItems().add(CompleteServiceRequest);</span>
<span class="nc" id="L917">    ServiceRequestMenu.getItems().add(UpdateServiceRequest);</span>

<span class="nc" id="L919">    newIcon.progressIndicator.setOnMouseClicked(</span>
<span class="nc" id="L920">        new EventHandler&lt;MouseEvent&gt;() {</span>
          @Override
          public void handle(MouseEvent event) {
<span class="nc" id="L923">            ServiceRequestMenu.show(newIcon.Icon, event.getScreenX(), event.getScreenY());</span>
<span class="nc" id="L924">          }</span>
        });
<span class="nc" id="L926">  }</span>

  private void createNewRadialMenus() {
<span class="nc" id="L929">    System.out.println(&quot;Creating radial menus...&quot;);</span>
<span class="nc bnc" id="L930" title="All 2 branches missed.">    for (MapLocationDot dot : locationsByFloor.get(currFloor)) {</span>
<span class="nc" id="L931">      List&lt;MapEquipmentIcon&gt; mapEquipmentIconsAtLocation = new LinkedList&lt;&gt;();</span>
<span class="nc bnc" id="L932" title="All 2 branches missed.">      for (MapEquipmentIcon i : mapIconsByFloor.get(currFloor)) {</span>
<span class="nc" id="L933">        Equipment e = i.getEquipment();</span>
<span class="nc bnc" id="L934" title="All 2 branches missed.">        if (e.getLocation().equalsByName(dot.getLocation())) {</span>
<span class="nc" id="L935">          mapEquipmentIconsAtLocation.add(i);</span>
        }
<span class="nc" id="L937">      }</span>

      // If there's more than 1 equipment per location, create a radial menu.
<span class="nc bnc" id="L940" title="All 2 branches missed.">      if (mapEquipmentIconsAtLocation.size() &gt; 1) {</span>
<span class="nc" id="L941">        System.out.println(&quot;Equipment sharing location!&quot;);</span>
<span class="nc" id="L942">        RadialEquipmentMenu r = new RadialEquipmentMenu(mapEquipmentIconsAtLocation);</span>
        // Make sure we don't already have this radial menu:
<span class="nc" id="L944">        boolean found = false;</span>
<span class="nc bnc" id="L945" title="All 2 branches missed.">        for (RadialEquipmentMenu rm : radialMenusByFloor.get(currFloor)) {</span>
<span class="nc bnc" id="L946" title="All 2 branches missed.">          if (r.toString().equals(rm.toString())) {</span>
<span class="nc" id="L947">            found = true;</span>
          }
<span class="nc" id="L949">        }</span>
<span class="nc bnc" id="L950" title="All 2 branches missed.">        if (!found) {</span>
<span class="nc" id="L951">          System.out.println(&quot;New radial menu detectedâ€” adding to HashMap...&quot;);</span>
<span class="nc" id="L952">          radialMenusByFloor.get(currFloor).add(r);</span>
        }
      }
<span class="nc" id="L955">    }</span>

    // Put on map
<span class="nc bnc" id="L958" title="All 2 branches missed.">    for (RadialEquipmentMenu rm : radialMenusByFloor.get(currFloor)) {</span>
<span class="nc" id="L959">      rm.hideIndividualIcons();</span>
<span class="nc" id="L960">      rm.place(MAPWIDTH, MAPHEIGHT);</span>
<span class="nc" id="L961">    }</span>
<span class="nc" id="L962">  }</span>

  private void closeRadialMenus(MouseEvent e) {
<span class="nc bnc" id="L965" title="All 2 branches missed.">    for (RadialEquipmentMenu rm : radialMenusByFloor.get(currFloor)) {</span>
<span class="nc" id="L966">      Point2D mouseLocation = layout.sceneToLocal(new Point2D(e.getSceneX(), e.getSceneY()));</span>
<span class="nc" id="L967">      double distance = rm.getDistanceToCoordinate(mouseLocation.getX(), mouseLocation.getY());</span>
<span class="nc bnc" id="L968" title="All 2 branches missed.">      if (distance &gt; rm.getRadius()) {</span>
<span class="nc" id="L969">        rm.hide();</span>
      }
<span class="nc" id="L971">    }</span>
<span class="nc" id="L972">  }</span>

  private void updateRadialMenus() {
<span class="nc bnc" id="L975" title="All 2 branches missed.">    for (RadialEquipmentMenu rm : radialMenusByFloor.get(currFloor)) {</span>
<span class="nc bnc" id="L976" title="All 2 branches missed.">      if (!rm.getIcons().isEmpty()) {</span>
<span class="nc bnc" id="L977" title="All 2 branches missed.">        for (MapEquipmentIcon i : rm.getIcons()) {</span>
<span class="nc bnc" id="L978" title="All 2 branches missed.">          if (!i.getEquipment().getLocation().equalsByName(rm.getLocation())) {</span>
<span class="nc" id="L979">            rm.removeEquipmentIcon(i);</span>
          }
<span class="nc" id="L981">        }</span>
      }

<span class="nc bnc" id="L984" title="All 2 branches missed.">      if (rm.getIcons().size() &lt; 2) {</span>
<span class="nc bnc" id="L985" title="All 2 branches missed.">        for (MapEquipmentIcon i : rm.getIcons()) {</span>
<span class="nc" id="L986">          i.getButton().setVisible(true);</span>
<span class="nc" id="L987">        }</span>
<span class="nc" id="L988">        radialMenusByFloor.get(currFloor).remove(rm);</span>
<span class="nc" id="L989">        rm.kill();</span>
      }
<span class="nc" id="L991">    }</span>
<span class="nc" id="L992">  }</span>

  // This is the longest method name I will tolerate. Do not do this.
  private void showEquipmentRemovedFromRadialMenus() {
<span class="nc" id="L996">    LinkedList&lt;MapEquipmentIcon&gt; iconsInMenus = new LinkedList&lt;&gt;();</span>
<span class="nc bnc" id="L997" title="All 2 branches missed.">    for (RadialEquipmentMenu rm : radialMenusByFloor.get(currFloor)) {</span>
<span class="nc" id="L998">      rm.getButton().setVisible(true);</span>
<span class="nc" id="L999">      iconsInMenus.addAll(rm.getIcons());</span>
<span class="nc" id="L1000">    }</span>
<span class="nc bnc" id="L1001" title="All 2 branches missed.">    for (MapEquipmentIcon i : mapIconsByFloor.get(currFloor)) {</span>
<span class="nc bnc" id="L1002" title="All 4 branches missed.">      if (!i.getButton().isVisible() &amp;&amp; !iconsInMenus.contains(i)) {</span>
<span class="nc" id="L1003">        i.getButton().setVisible(true);</span>
      }
<span class="nc" id="L1005">    }</span>
<span class="nc" id="L1006">  }</span>

  private static class Position {
    double x;
    double y;
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.4.201905082037</span></div></body></html>